generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model CompanyConfig {
  id       String @id @default(uuid())
  tenantId String @unique
  
  // Company Details
  companyName String
  industry    String
  size        String // SMALL | MEDIUM | LARGE
  country     String?
  currency    String?
  timezone    String?
  fiscalYear  String?
  
  // Workflow Configuration
  workflowConfig Json? // Custom workflow rules per module
  
  // Module Settings
  enabledModules Json? // ["INVENTORY", "HR", "FINANCE"]
  
  // Approval Settings
  approvalLevels Json? // {"inventory": 2, "expense": 3, "leave": 1}
  
  // Custom Fields
  customFields Json? // Module-specific custom fields
  
  // Business Rules
  businessRules Json? // Custom validation rules
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model User {
  id       String @id @default(uuid())
  email    String @unique
  password String
  role     String @default("USER")
  status   String @default("ACTIVE")

  tenantId     String
  departmentId String?
  managerId    String?

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  department Department? @relation(fields: [departmentId], references: [id])
  roles      UserRole[]
  employee   Employee?
  
  // CRM Relations
  customersOwned      Customer[]       @relation("CustomerOwner")
  contactsOwned       Contact[]        @relation("ContactOwner")
  leadsOwned          Lead[]           @relation("LeadOwner")
  dealsOwned          Deal[]           @relation("DealOwner")
  communicationsCreated Communication[] @relation("CommCreator")
  activitiesAssigned  Activity[]       @relation("ActivityAssignee")
  activitiesCreated   Activity[]       @relation("ActivityCreator")
  customerNotesCreated CustomerNote[]  @relation("NoteCreator")
  attachmentsUploaded Attachment[]     @relation("AttachmentUploader")

  createdAt DateTime @default(now())
}

model Role {
  id       String @id @default(uuid())
  name     String
  tenantId String

  permissions RolePermission[]
  users       UserRole[]

  @@unique([name, tenantId])
}

model Permission {
  id    String @id @default(uuid())
  code  String @unique
  label String

  roles RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

model Department {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  location    String?
  managerId   String?
  budget      Float?
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  employees Employee[]
  User      User[]
  projects  Project[]
}

model Workflow {
  id       String @id @default(uuid())
  tenantId String
  module   String // INVENTORY, HR, FINANCE
  action   String // CREATE, UPDATE, DELETE
  status   String @default("ACTIVE") // ACTIVE, REJECTED

  steps     WorkflowStep[]
  approvals Approval[]
  createdAt DateTime     @default(now())
}

model WorkflowStep {
  id         String @id @default(uuid())
  workflowId String
  stepOrder  Int
  permission String // inventory.approve, finance.approve

  workflow  Workflow   @relation(fields: [workflowId], references: [id])
  approvals Approval[]
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  tenantId  String
  action    String
  entity    String
  entityId  String
  meta      Json?
  timestamp DateTime @default(now())
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  users   User[]
  config  CompanyConfig?
  items   Item[]
  invites UserInvite[]
  salesQuotations SalesQuotation[]
  salesOrders SalesOrder[]
  salesInvoices SalesInvoice[]
  salesTrackings SalesOrderTracking[]
}

model Item {
  id          String   @id @default(uuid())
  name        String
  sku         String
  price       Float
  quantity    Int      @default(0)
  description String?
  category    String?
  tenantId    String
  createdAt   DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([sku, tenantId])
}

model SalesQuotation {
  id            String   @id @default(uuid())
  tenantId      String
  customerId    String?
  dealId        String?
  customerName  String
  customerEmail String?
  title         String
  description   String?
  items         Json?
  subtotal      Float    @default(0)
  tax           Float    @default(0)
  discount      Float    @default(0)
  total         Float    @default(0)
  status        String   @default("DRAFT") // DRAFT | SENT | ACCEPTED | REJECTED | EXPIRED
  validUntil    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])
  deal     Deal?     @relation(fields: [dealId], references: [id])
}

model SalesOrder {
  id               String   @id @default(uuid())
  tenantId         String
  customerId       String?
  dealId           String?
  orderNumber      String?
  customerName     String
  customerEmail    String?
  quotationId      String?
  orderDate        DateTime @default(now())
  expectedDelivery DateTime?
  items            Json?
  subtotal         Float    @default(0)
  tax              Float    @default(0)
  discount         Float    @default(0)
  total            Float    @default(0)
  status           String   @default("PENDING") // PENDING | CONFIRMED | SHIPPED | DELIVERED | CANCELLED
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant    Tenant               @relation(fields: [tenantId], references: [id])
  customer  Customer?            @relation(fields: [customerId], references: [id])
  deal      Deal?                @relation(fields: [dealId], references: [id])
  tracking  SalesOrderTracking[]
}

model SalesInvoice {
  id            String   @id @default(uuid())
  tenantId      String
  customerId    String?
  dealId        String?
  invoiceNumber String?
  customerName  String
  customerEmail String?
  orderId       String?
  issueDate     DateTime @default(now())
  dueDate       DateTime?
  items         Json?
  subtotal      Float    @default(0)
  tax           Float    @default(0)
  discount      Float    @default(0)
  total         Float    @default(0)
  amountPaid    Float    @default(0)
  status        String   @default("DRAFT") // DRAFT | SENT | PAID | PARTIALLY_PAID | OVERDUE
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])
  deal     Deal?     @relation(fields: [dealId], references: [id])
  payments InvoicePayment[]
}

model InvoicePayment {
  id             String   @id @default(uuid())
  tenantId       String
  invoiceId      String
  amount         Float
  paymentDate    DateTime @default(now())
  paymentMethod  String?  // CASH | BANK_TRANSFER | CREDIT_CARD | DEBIT_CARD | CHECK | UPI | OTHER
  referenceNumber String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  invoice SalesInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model SalesOrderTracking {
  id             String   @id @default(uuid())
  tenantId       String
  salesOrderId   String
  status         String   @default("PENDING") // PENDING | PROCESSING | SHIPPED | IN_TRANSIT | DELIVERED | DELAYED | CANCELLED
  carrier        String?
  trackingNumber String?
  location       String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  order  SalesOrder @relation(fields: [salesOrderId], references: [id])
}

model UserInvite {
  id        String   @id @default(uuid())
  email     String
  role      String   @default("USER")
  token     String   @unique
  used      Boolean  @default(false)
  expiresAt DateTime
  tenantId  String
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model Approval {
  id                String    @id @default(uuid())
  workflowId        String
  workflowRequestId String?
  workflowStepId    String?
  stepOrder         Int
  permission        String
  data              Json?
  tenantId          String
  approvedBy        String?
  approvedAt        DateTime?
  status            String    // PENDING | APPROVED | REJECTED
  comment           String?
  rejectionReason   String?
  createdAt         DateTime  @default(now())

  workflow        Workflow       @relation(fields: [workflowId], references: [id])
  workflowRequest WorkflowRequest? @relation(fields: [workflowRequestId], references: [id])
  workflowStep    WorkflowStep?  @relation(fields: [workflowStepId], references: [id])
}

model SystemOption {
  id        String   @id @default(uuid())
  category  String
  key       String
  value     String
  label     String?
  tenantId  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([category, key, tenantId], name: "category_key_tenantId")
}

model WorkflowRequest {
  id         String   @id @default(uuid())
  tenantId   String
  workflowId String?
  module     String
  action     String
  payload    Json // original request body
  status     String // PENDING | COMPLETED | REJECTED
  createdBy  String // Keep old field
  requestedBy String? // Add new optional field
  createdAt  DateTime @default(now())
  
  approvals  Approval[]
}

model Employee {
  id           String  @id @default(uuid())
  tenantId     String
  userId       String  @unique
  departmentId String
  managerId    String?

  employeeCode String
  name         String
  email        String
  phone        String?
  designation  String
  joiningDate  DateTime
  status       String

  createdAt DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id])
  department Department @relation(fields: [departmentId], references: [id])
  manager    Employee?  @relation("EmployeeManager", fields: [managerId], references: [id])
  reports    Employee[] @relation("EmployeeManager")

  expenseClaims   ExpenseClaim[]
  LeaveRequest    LeaveRequest[]
  tasks           Task[]
  assignedTasks   Task[] @relation("TaskAssigner")
  salaryStructure SalaryStructure?
  workReports     WorkReport[]
  notifications   Notification[]
  payslips        Payslip[]
  disbursements   SalaryDisbursement[]
  attendance      Attendance[]
  
  // Attendance & Time Tracking
  shiftAssignments ShiftAssignment[]
  timeTracking    TimeTracking[]
  overtimeRecords OvertimeRecord[] @relation("EmployeeOvertime")
  attendanceReports AttendanceReport[] @relation("EmployeeAttendanceReport")
  leaveIntegrations LeaveIntegration[] @relation("EmployeeLeaveIntegration")
  
  // Asset Management
  assetAllocations AssetAllocation[]
}

model LeaveType {
  id       String @id @default(uuid())
  tenantId String

  name            String
  code            String
  maxDays         Int
  paid            Boolean
  requiresApproval Boolean @default(true)

  createdAt DateTime @default(now())

  // Ã¢Å“â€¦ ADD THIS
  leaveRequests LeaveRequest[]
}

model LeaveRequest {
  id          String @id @default(uuid())
  tenantId    String
  employeeId  String
  leaveTypeId String

  startDate DateTime
  endDate   DateTime
  reason    String

  status String // PENDING | APPROVED | REJECTED

  createdAt DateTime @default(now())

  employee  Employee  @relation(fields: [employeeId], references: [id])
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])
}

model ExpenseCategory {
  id       String @id @default(uuid())
  tenantId String

  name   String
  code   String // TRAVEL, FOOD, OFFICE
  active Boolean @default(true)

  createdAt     DateTime       @default(now())
  expenseClaims ExpenseClaim[]
}

model ExpenseClaim {
  id         String @id @default(uuid())
  tenantId   String
  employeeId String
  categoryId String

  title       String
  amount      Float
  description String?
  receiptUrl  String?
  expenseDate DateTime

  status String // PENDING | APPROVED | REJECTED

  createdAt DateTime @default(now())

  employee Employee        @relation(fields: [employeeId], references: [id])
  category ExpenseCategory @relation(fields: [categoryId], references: [id])
}

model Task {
  id          String @id @default(uuid())
  tenantId    String
  employeeId  String
  assignedBy  String
  
  title       String
  description String
  priority    String // LOW | MEDIUM | HIGH | URGENT
  status      String @default("PENDING") // PENDING | IN_PROGRESS | COMPLETED
  dueDate     DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  employee    Employee @relation(fields: [employeeId], references: [id])
  assigner    Employee @relation("TaskAssigner", fields: [assignedBy], references: [id])
  reports     WorkReport[]
}

model SalaryStructure {
  id          String @id @default(uuid())
  tenantId    String
  employeeId  String @unique
  
  basicSalary Float
  allowances  Json // {"hra": 5000, "transport": 2000, "medical": 1500}
  deductions  Json // {"pf": 1800, "tax": 3000, "insurance": 500}
  netSalary   Float
  
  effectiveFrom DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  employee    Employee @relation(fields: [employeeId], references: [id])
}

model WorkReport {
  id          String @id @default(uuid())
  tenantId    String
  employeeId  String
  taskId      String?
  
  title       String
  description String
  workDate    DateTime
  hoursSpent  Float?
  attachments Json? // Array of file URLs/paths
  
  createdAt   DateTime @default(now())
  
  employee    Employee @relation(fields: [employeeId], references: [id])
  task        Task?    @relation(fields: [taskId], references: [id])
}

model Notification {
  id         String @id @default(uuid())
  tenantId   String
  employeeId String
  
  type       String // TASK_ASSIGNED | DEADLINE_REMINDER | TASK_OVERDUE | SALARY_UPDATE
  title      String
  message    String
  isRead     Boolean @default(false)
  
  createdAt  DateTime @default(now())
  
  employee   Employee @relation(fields: [employeeId], references: [id])
}

model Customer {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  
  // Existing fields
  industry  String?
  website   String?
  status    String   @default("ACTIVE")
  notes     String?
  
  // New fields - Basic Info
  type              String?  @default("BUSINESS") // BUSINESS | INDIVIDUAL
  companySize       String?  // SMALL | MEDIUM | LARGE | ENTERPRISE
  annualRevenue     Float?
  currencyCode      String?  @default("USD")
  
  // Contact Information
  primaryEmail      String?
  primaryPhone      String?
  billingAddress    Json?    // {street, city, state, zip, country}
  shippingAddress   Json?    // {street, city, state, zip, country}
  
  // Relationship Management
  ownerId           String?  // User responsible
  accountManager    String?  // User ID
  category          String?  // CUSTOMER | PARTNER | PROSPECT
  source            String?  // WEB | REFERRAL | EVENT | CAMPAIGN
  
  // Engagement
  firstContactDate  DateTime?
  lastContactDate   DateTime?
  preferredChannel  String?  // EMAIL | PHONE | SMS | IN_PERSON
  timezone          String?
  
  // Metadata
  tags              String[] @default([]) // Array of tag strings
  customFields      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contacts       Contact[]
  deals          Deal[]
  communications Communication[]
  leads          Lead[]
  activities     Activity[]
  customerNotes  CustomerNote[]
  attachments    Attachment[]
  salesQuotations SalesQuotation[]
  salesOrders     SalesOrder[]
  salesInvoices   SalesInvoice[]
  
  owner          User?    @relation("CustomerOwner", fields: [ownerId], references: [id])
  
  @@index([tenantId, status])
  @@index([tenantId, ownerId])
  @@index([tenantId, category])
}

model Contact {
  id         String   @id @default(uuid())
  tenantId   String
  customerId String

  // Existing fields
  name   String
  email  String?
  phone  String?
  title  String?
  status String   @default("ACTIVE")
  
  // New fields
  firstName         String?
  lastName          String?
  jobTitle          String?
  department        String?
  role              String?  // DECISION_MAKER | INFLUENCER | USER | GATEKEEPER
  
  // Contact Details
  mobilePhone       String?
  workPhone         String?
  linkedinUrl       String?
  twitterHandle     String?
  
  // Relationship
  isPrimary         Boolean  @default(false)
  ownerId           String?  // User responsible
  preferredChannel  String?  // EMAIL | PHONE | SMS
  
  // Engagement
  lastContactDate   DateTime?
  birthday          DateTime?
  anniversary       DateTime?
  
  // Preferences
  emailOptIn        Boolean  @default(true)
  smsOptIn          Boolean  @default(false)
  doNotCall         Boolean  @default(false)
  
  // Metadata
  tags              String[] @default([])
  customFields      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer       Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  communications Communication[]
  leads          Lead[]
  activities     Activity[]
  
  owner          User?          @relation("ContactOwner", fields: [ownerId], references: [id])
  
  @@index([tenantId, customerId])
  @@index([tenantId, email])
  @@index([tenantId, ownerId])
}

model Lead {
  id        String   @id @default(uuid())
  tenantId  String

  // Existing fields
  name     String
  email    String?
  phone    String?
  company  String?
  source   String?
  status   String   @default("NEW") // NEW | QUALIFIED | CONVERTED | LOST | DISQUALIFIED
  notes    String?

  customerId String?
  contactId  String?
  
  // New fields
  firstName         String?
  lastName          String?
  jobTitle          String?
  
  // Lead Classification
  leadScore         Int      @default(0) // 0-100
  rating            String?  // HOT | WARM | COLD
  priority          String?  @default("MEDIUM") // LOW | MEDIUM | HIGH
  
  // Source Tracking
  campaign          String?
  medium            String?  // ORGANIC | PAID | SOCIAL | REFERRAL | DIRECT
  referrer          String?
  
  // Qualification
  budget            Float?
  timeline          String?  // IMMEDIATE | 1_3_MONTHS | 3_6_MONTHS | 6_12_MONTHS | 12_PLUS_MONTHS
  authority         String?  // YES | NO | UNKNOWN
  need              String?  // EXPLICIT | IMPLIED
  
  // Assignment
  ownerId           String?  // User responsible
  assignedAt        DateTime?
  
  // Conversion
  convertedAt       DateTime?
  conversionSource  String?  // MANUAL | AUTOMATED
  dealId            String?  // Deal created from conversion
  
  // Engagement
  firstContactDate  DateTime?
  lastContactDate   DateTime?
  lastActivityDate  DateTime?
  
  // Disqualification
  disqualifiedAt    DateTime?
  disqualifiedBy    String?
  disqualifiedReason String?
  
  // Metadata
  tags              String[] @default([])
  customFields      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer       Customer?       @relation(fields: [customerId], references: [id])
  contact        Contact?        @relation(fields: [contactId], references: [id])
  communications Communication[]
  activities     Activity[]
  deal           Deal?           @relation("LeadDeal", fields: [dealId], references: [id])
  
  owner          User?           @relation("LeadOwner", fields: [ownerId], references: [id])
  
  @@index([tenantId, status])
  @@index([tenantId, ownerId])
  @@index([tenantId, leadScore])
  @@index([tenantId, source])
}

model Deal {
  id        String   @id @default(uuid())
  tenantId  String
  customerId String

  // Existing fields
  name      String
  stage     String   @default("PROSPECTING") // PROSPECTING | QUALIFICATION | PROPOSAL | NEGOTIATION | WON | LOST
  value     Float    @default(0)
  expectedCloseDate DateTime?
  status    String   @default("OPEN") // OPEN | WON | LOST
  notes     String?
  
  // New fields
  dealNumber        String?  @unique
  
  // Pipeline
  pipelineId        String?  @default("default")
  stageOrder        Int?     @default(0)
  probability       Int?     @default(0) // 0-100
  
  // Financial
  amount            Float    @default(0)
  currencyCode      String?  @default("USD")
  discount          Float?   @default(0)
  tax               Float?   @default(0)
  total             Float?   @default(0)
  
  // Products/Services
  products          Json?    // [{productId, name, quantity, price, total}]
  
  // Assignment
  ownerId           String?  // User responsible
  teamMembers       String[] @default([]) // Array of User IDs
  
  // Dates
  createdDate       DateTime @default(now())
  closedDate        DateTime?
  firstContactDate  DateTime?
  lastActivityDate  DateTime?
  
  // Competition
  competitors       String[] @default([]) // Array of competitor names
  
  // Closure
  wonReason         String?
  lostReason        String?  // PRICE | COMPETITION | NO_BUDGET | TIMING | PRODUCT_FIT | OTHER
  lostToCompetitor  String?
  
  // Source
  leadId            String?  // Converted from lead
  source            String?  // INBOUND | OUTBOUND | REFERRAL | PARTNER
  
  // Metadata
  tags              String[] @default([])
  customFields      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer        Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  salesQuotations SalesQuotation[]
  salesOrders     SalesOrder[]
  salesInvoices   SalesInvoice[]
  communications  Communication[]
  activities      Activity[]
  attachments     Attachment[]
  leadConverted   Lead[]           @relation("LeadDeal")
  
  owner           User?            @relation("DealOwner", fields: [ownerId], references: [id])
  pipeline        Pipeline?        @relation(fields: [pipelineId], references: [id])
  
  @@index([tenantId, customerId])
  @@index([tenantId, stage])
  @@index([tenantId, status])
  @@index([tenantId, ownerId])
  @@index([tenantId, expectedCloseDate])
}

model Communication {
  id        String   @id @default(uuid())
  tenantId  String

  // Existing fields
  type      String   // CALL | EMAIL | MEETING | NOTE | SMS | CHAT
  subject   String?
  notes     String
  occurredAt DateTime
  createdBy String?

  customerId String?
  contactId  String?
  leadId     String?
  
  // New fields
  direction         String?  // INBOUND | OUTBOUND
  duration          Int?     // Minutes for calls/meetings
  outcome           String?  // SUCCESSFUL | NO_ANSWER | LEFT_MESSAGE | FOLLOW_UP_REQUIRED
  
  // Email specific
  emailFrom         String?
  emailTo           String?
  emailCc           String?
  
  // Meeting specific
  meetingLocation   String?
  meetingAttendees  String[] @default([]) // Array of contact/user names
  
  // Integration
  dealId            String?
  activityId        String?  // Related activity/task
  
  // Attachments
  hasAttachments    Boolean  @default(false)
  attachmentCount   Int      @default(0)
  
  // Metadata
  tags              String[] @default([])
  customFields      Json?

  createdAt DateTime @default(now())

  customer   Customer?   @relation(fields: [customerId], references: [id])
  contact    Contact?    @relation(fields: [contactId], references: [id])
  lead       Lead?       @relation(fields: [leadId], references: [id])
  deal       Deal?       @relation(fields: [dealId], references: [id])
  activity   Activity?   @relation(fields: [activityId], references: [id])
  attachments Attachment[]
  
  creator    User?       @relation("CommCreator", fields: [createdBy], references: [id])
  
  @@index([tenantId, customerId])
  @@index([tenantId, contactId])
  @@index([tenantId, leadId])
  @@index([tenantId, dealId])
  @@index([tenantId, occurredAt])
}

// CRM Supporting Models

model Pipeline {
  id          String   @id @default(uuid())
  tenantId    String
  name        String   // "Sales Pipeline", "Consulting Pipeline"
  description String?
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  stages      PipelineStage[]
  deals       Deal[]
  
  @@unique([tenantId, name])
  @@index([tenantId, isDefault])
}

model PipelineStage {
  id          String   @id @default(uuid())
  tenantId    String
  pipelineId  String
  
  name        String   // "Prospecting", "Qualification", "Proposal"
  order       Int      // Display order
  probability Int      @default(0) // Default win probability 0-100
  color       String?  // Hex color for UI
  
  // Stage behavior
  isClosedWon Boolean  @default(false)
  isClosedLost Boolean @default(false)
  
  // Automation
  daysInStage Int?     // Alert if deal stays too long
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  pipeline    Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  
  @@unique([pipelineId, name])
  @@unique([pipelineId, order])
  @@index([tenantId, pipelineId])
}

model Activity {
  id          String   @id @default(uuid())
  tenantId    String
  
  type        String   // TASK | CALL | EMAIL | MEETING | TODO
  subject     String
  description String?
  
  // Status
  status      String   @default("PENDING") // PENDING | IN_PROGRESS | COMPLETED | CANCELLED
  priority    String   @default("MEDIUM") // LOW | MEDIUM | HIGH | URGENT
  
  // Scheduling
  dueDate     DateTime?
  dueTime     String?  // HH:MM
  reminderAt  DateTime?
  
  // Completion
  completedAt DateTime?
  completedBy String?
  
  // Assignment
  assignedTo  String?  // User ID
  createdBy   String
  
  // Entity Relations
  customerId  String?
  contactId   String?
  leadId      String?
  dealId      String?
  
  // Result
  outcome     String?
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  customer        Customer?       @relation(fields: [customerId], references: [id])
  contact         Contact?        @relation(fields: [contactId], references: [id])
  lead            Lead?           @relation(fields: [leadId], references: [id])
  deal            Deal?           @relation(fields: [dealId], references: [id])
  communications  Communication[]
  
  assignee        User?           @relation("ActivityAssignee", fields: [assignedTo], references: [id])
  creator         User            @relation("ActivityCreator", fields: [createdBy], references: [id])
  
  @@index([tenantId, assignedTo])
  @@index([tenantId, status])
  @@index([tenantId, dueDate])
  @@index([tenantId, customerId])
  @@index([tenantId, dealId])
}

model CustomerNote {
  id          String   @id @default(uuid())
  tenantId    String
  customerId  String
  
  title       String?
  content     String
  isPinned    Boolean  @default(false)
  
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  creator     User     @relation("NoteCreator", fields: [createdBy], references: [id])
  
  @@index([tenantId, customerId])
}

model Attachment {
  id          String   @id @default(uuid())
  tenantId    String
  
  fileName    String
  fileSize    Int      // Bytes
  mimeType    String
  fileUrl     String   // S3/storage URL
  
  // Entity Relations (polymorphic)
  customerId      String?
  dealId          String?
  communicationId String?
  
  uploadedBy  String
  createdAt   DateTime @default(now())
  
  customer        Customer?      @relation(fields: [customerId], references: [id])
  deal            Deal?          @relation(fields: [dealId], references: [id])
  communication   Communication? @relation(fields: [communicationId], references: [id])
  
  uploader    User     @relation("AttachmentUploader", fields: [uploadedBy], references: [id])
  
  @@index([tenantId, customerId])
  @@index([tenantId, dealId])
}

model Tag {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  color       String?
  category    String?  // CUSTOMER | LEAD | DEAL | GENERAL
  
  usageCount  Int      @default(0)
  
  createdAt   DateTime @default(now())
  
  @@unique([tenantId, name, category])
  @@index([tenantId, category])
}


model PasswordReset {
  id        String   @id @default(uuid())
  email     String
  otp       String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([email, otp])
}

// Purchase Management Models

model Vendor {
  id              String   @id @default(uuid())
  tenantId        String
  vendorCode      String   @unique
  name            String
  contactPerson   String?
  email           String?
  phone           String?
  address         String?
  city            String?
  state           String?
  country         String?
  postalCode      String?
  website         String?
  
  // Business Details
  taxId           String?
  paymentTerms    String?  // NET30, NET60, NET90, COD
  creditLimit     Float?
  currency        String   @default("USD")
  
  // Status & Category
  status          String   @default("ACTIVE") // ACTIVE, INACTIVE, BLOCKED
  category        String?  // RAW_MATERIALS, SERVICES, EQUIPMENT, etc.
  
  // Banking Details
  bankName        String?
  accountNumber   String?
  swiftCode       String?
  
  // Ratings & Notes
  rating          Float?   @default(0) // 0-5 star rating
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  purchaseRequisitions PurchaseRequisition[]
  purchaseOrders       PurchaseOrder[]
  evaluations          SupplierEvaluation[]
  bills                APBill[]    @relation("VendorBills")
  payments             Payment[]   @relation("VendorPayments")
}

model PurchaseRequisition {
  id              String   @id @default(uuid())
  tenantId        String
  requisitionNumber String @unique
  requestedBy     String   // Employee/User ID
  departmentId    String?
  vendorId        String?
  
  title           String
  description     String?
  priority        String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  
  // Dates
  requestedDate   DateTime @default(now())
  requiredDate    DateTime
  
  // Status & Approval
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED, CONVERTED
  approvalStatus  String   @default("PENDING") // PENDING, APPROVED, REJECTED
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?
  
  // Items (stored as JSON array)
  items           Json     // [{itemName, description, quantity, estimatedPrice, unit}]
  
  // Financials
  totalAmount     Float    @default(0)
  budgetCode      String?
  
  // Workflow
  workflowId      String?
  
  notes           String?
  attachments     Json?    // Array of file URLs
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  vendor          Vendor?  @relation(fields: [vendorId], references: [id])
  purchaseOrders  PurchaseOrder[]
}

model PurchaseOrder {
  id              String   @id @default(uuid())
  tenantId        String
  poNumber        String   @unique
  requisitionId   String?
  vendorId        String
  
  title           String
  description     String?
  
  // Dates
  orderDate       DateTime @default(now())
  expectedDeliveryDate DateTime
  actualDeliveryDate   DateTime?
  
  // Status
  status          String   @default("DRAFT") // DRAFT, SENT, CONFIRMED, SHIPPED, RECEIVED, CANCELLED
  
  // Items (stored as JSON array)
  items           Json     // [{itemName, description, quantity, unitPrice, unit, tax, discount, total}]
  
  // Financials
  subtotal        Float    @default(0)
  taxAmount       Float    @default(0)
  discountAmount  Float    @default(0)
  shippingCost    Float    @default(0)
  totalAmount     Float    @default(0)
  
  // Payment
  paymentTerms    String?  // NET30, NET60, etc.
  paymentStatus   String   @default("UNPAID") // UNPAID, PARTIAL, PAID
  paidAmount      Float    @default(0)
  
  // Shipping Details
  shippingAddress String?
  shippingMethod  String?
  trackingNumber  String?
  
  // Approval
  approvalStatus  String   @default("PENDING") // PENDING, APPROVED, REJECTED
  approvedBy      String?
  approvedAt      DateTime?
  
  // Workflow
  workflowId      String?
  
  notes           String?
  attachments     Json?    // Array of file URLs/documents
  internalNotes   String?
  
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  vendor          Vendor            @relation(fields: [vendorId], references: [id])
  requisition     PurchaseRequisition? @relation(fields: [requisitionId], references: [id])
  receipts        GoodsReceipt[]
  bills           APBill[]          @relation("POBills")
}

model GoodsReceipt {
  id              String   @id @default(uuid())
  tenantId        String
  receiptNumber   String   @unique
  purchaseOrderId String
  
  receivedDate    DateTime @default(now())
  receivedBy      String   // Employee/User ID
  
  // Receipt Details
  items           Json     // [{itemName, orderedQty, receivedQty, rejectedQty, condition, notes}]
  
  status          String   @default("RECEIVED") // RECEIVED, INSPECTED, ACCEPTED, REJECTED
  qualityStatus   String?  // PASSED, FAILED, PARTIAL
  
  // Storage
  warehouseLocation String?
  
  notes           String?
  attachments     Json?    // Photos, inspection reports
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
}

model SupplierEvaluation {
  id              String   @id @default(uuid())
  tenantId        String
  vendorId        String
  evaluatedBy     String   // Employee/User ID
  
  evaluationDate  DateTime @default(now())
  evaluationPeriod String? // Q1-2024, Monthly-Jan-2024
  
  // Evaluation Criteria (1-5 scale)
  qualityRating   Float    @default(0)
  deliveryRating  Float    @default(0)
  priceRating     Float    @default(0)
  serviceRating   Float    @default(0)
  communicationRating Float @default(0)
  
  // Overall
  overallRating   Float    @default(0)
  
  // Performance Metrics
  onTimeDeliveryRate Float? // Percentage
  defectRate         Float? // Percentage
  responseTime       String? // Average response time
  
  // Feedback
  strengths       String?
  weaknesses      String?
  recommendations String?
  
  // Status
  status          String   @default("COMPLETED") // DRAFT, COMPLETED
  
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  vendor          Vendor   @relation(fields: [vendorId], references: [id])
}

model APBill {
  id              String   @id @default(uuid())
  tenantId        String
  billNumber      String   @unique
  vendorId        String
  purchaseOrderId String?
  
  // Bill Details
  billDate        DateTime
  dueDate         DateTime
  invoiceNumber   String?  // Vendor's invoice number
  invoiceDate     DateTime?
  
  // Amounts
  subtotal        Float    @default(0)
  taxAmount       Float    @default(0)
  discountAmount  Float    @default(0)
  shippingCost    Float    @default(0)
  totalAmount     Float    @default(0)
  paidAmount      Float    @default(0)
  balanceAmount   Float    @default(0)
  
  // Line Items
  items           Json     // [{description, quantity, unitPrice, amount, glAccount}]
  
  // Status
  status          String   @default("PENDING") // PENDING, APPROVED, PARTIALLY_PAID, PAID, OVERDUE, CANCELLED
  approvalStatus  String   @default("PENDING") // PENDING, APPROVED, REJECTED
  
  // Matching Status
  matchedToPO     Boolean  @default(false)
  matchedToReceipt Boolean @default(false)
  threeWayMatched Boolean  @default(false)
  
  // Payment Terms
  paymentTerms    String?  // NET30, NET60, NET90, COD
  
  // GL Integration
  glPosted        Boolean  @default(false)
  glPostDate      DateTime?
  glJournalId     String?
  
  // Approvals
  approvedBy      String?
  approvedAt      DateTime?
  
  // Notes
  notes           String?
  internalNotes   String?
  attachments     Json?
  
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  vendor          Vendor          @relation("VendorBills", fields: [vendorId], references: [id])
  purchaseOrder   PurchaseOrder?  @relation("POBills", fields: [purchaseOrderId], references: [id])
}

model Payment {
  id              String   @id @default(uuid())
  tenantId        String
  paymentNumber   String   @unique
  vendorId        String
  
  // Payment Details
  paymentDate     DateTime
  amount          Float
  
  // Payment Method
  paymentMethod   String   // CHECK, WIRE, ACH, CREDIT_CARD, CASH
  referenceNumber String?  // Check number, transaction ID
  bankAccount     String?
  
  // Status
  status          String   @default("PENDING") // PENDING, CLEARED, RETURNED, CANCELLED, SCHEDULED
  clearedDate     DateTime?
  
  // Bill Allocations
  allocations     Json     // [{billId, billNumber, allocatedAmount}]
  
  // GL Integration
  glPosted        Boolean  @default(false)
  glPostDate      DateTime?
  glJournalId     String?
  
  // Notes
  notes           String?
  attachments     Json?    // Payment receipts, remittance advice
  
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  vendor          Vendor   @relation("VendorPayments", fields: [vendorId], references: [id])
}

model WorkflowTemplate {
  id          String @id @default(uuid())
  name        String
  description String
  industry    String // MANUFACTURING | IT | RETAIL | HEALTHCARE
  module      String // INVENTORY | HR | FINANCE
  
  steps       Json   // Predefined workflow steps
  isDefault   Boolean @default(false)
  
  createdAt   DateTime @default(now())
}

model CustomField {
  id       String @id @default(uuid())
  tenantId String
  module   String // EMPLOYEE | INVENTORY | EXPENSE
  
  fieldName String
  fieldType String // TEXT | NUMBER | DATE | DROPDOWN | BOOLEAN
  options   Json?  // For dropdown fields
  required  Boolean @default(false)
  
  createdAt DateTime @default(now())
}

model ApprovalMatrix {
  id       String @id @default(uuid())
  tenantId String
  module   String // INVENTORY | EXPENSE | LEAVE
  
  conditions Json // Amount ranges, department rules
  approvers  Json // Role-based approver hierarchy
  
  createdAt DateTime @default(now())
}

// ============================================
// PROJECT MANAGEMENT MODULE
// ============================================

model Project {
  id              String   @id @default(uuid())
  tenantId        String
  projectCode     String   @unique
  projectName     String
  description     String?
  
  // Project Details
  clientName      String?
  projectManager  String   // Employee/User ID
  status          String   @default("PLANNING") // PLANNING, IN_PROGRESS, ON_HOLD, COMPLETED, CANCELLED
  priority        String   @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  type            String?  // INTERNAL, CLIENT, R&D
  
  // Dates
  startDate       DateTime?
  endDate         DateTime?
  actualStartDate DateTime?
  actualEndDate   DateTime?
  
  // Budget
  estimatedBudget Float    @default(0)
  actualCost      Float    @default(0)
  
  // Progress
  progressPercent Float    @default(0)
  
  // Computed/Rollup fields
  totalPlannedHours   Float    @default(0)
  totalActualHours    Float    @default(0)
  totalResourceCost   Float    @default(0)
  budgetVariance      Float    @default(0)
  scheduleVariance    Int      @default(0) // Days ahead/behind
  
  // Capacity & Health
  utilizationPercent  Float    @default(0)
  healthScore         String   @default("GREEN") // GREEN, YELLOW, RED
  riskLevel           String   @default("LOW")   // LOW, MEDIUM, HIGH, CRITICAL
  
  // Team
  departmentId    String?
  teamMembers     Json?    // Deprecated - use ProjectMember relation
  
  // Integrations
  documentFolderId    String?  // Link to document management
  financeAccountId    String?  // Link to finance accounts
  
  // Custom Fields
  customFields    Json?
  
  notes           String?
  attachments     Json?    // Array of file URLs/documents
  
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  department      Department?         @relation(fields: [departmentId], references: [id])
  members         ProjectMember[]
  milestones      ProjectMilestone[]
  resources       ProjectResource[]
  budgets         ProjectBudget[]
  timeLogs        ProjectTimeLog[]
  
  @@index([status, priority])
  @@index([projectManager])
  @@index([departmentId])
  @@index([healthScore])
}

model ProjectMember {
  id                String   @id @default(uuid())
  tenantId          String
  projectId         String
  employeeId        String
  userId            String?  // Link to user account
  
  role              String   // PROJECT_MANAGER, TEAM_LEAD, DEVELOPER, DESIGNER, etc.
  allocationPercent Float    @default(100)
  
  startDate         DateTime
  endDate           DateTime?
  status            String   @default("ACTIVE") // ACTIVE, INACTIVE, COMPLETED
  
  hourlyRate        Float?   // Override project rate
  permissions       Json?    // Specific project permissions
  
  notes             String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  project           Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([projectId])
  @@index([employeeId])
  @@index([tenantId])
  @@index([status])
}

model ProjectMilestone {
  id              String   @id @default(uuid())
  tenantId        String
  projectId       String
  
  milestoneName   String
  description     String?
  status          String   @default("NOT_STARTED") // NOT_STARTED, IN_PROGRESS, COMPLETED, DELAYED
  
  // Dates
  startDate       DateTime?
  dueDate         DateTime?
  completedDate   DateTime?
  
  // Tracking
  progressPercent Float    @default(0)
  assignedTo      String?  // Employee/User ID
  
  // Deliverables
  deliverables    Json?    // [{name, status, dueDate}]
  
  // Dependencies & Scheduling
  isCriticalPath  Boolean  @default(false)
  isAutoScheduled Boolean  @default(false)
  
  notes           String?
  attachments     Json?
  
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  predecessors    ProjectMilestoneDependency[] @relation("SuccessorDependencies")
  successors      ProjectMilestoneDependency[] @relation("PredecessorDependencies")
}

model ProjectMilestoneDependency {
  id              String   @id @default(uuid())
  tenantId        String
  
  predecessorId   String   // Milestone that must finish first
  successorId     String   // Milestone that depends on predecessor
  
  dependencyType  String   @default("FS") // FS (Finish-to-Start), SS (Start-to-Start), FF (Finish-to-Finish), SF (Start-to-Finish)
  lagDays         Int      @default(0)    // Lag time in days (can be negative for lead)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  predecessor     ProjectMilestone @relation("PredecessorDependencies", fields: [predecessorId], references: [id], onDelete: Cascade)
  successor       ProjectMilestone @relation("SuccessorDependencies", fields: [successorId], references: [id], onDelete: Cascade)
  
  @@unique([predecessorId, successorId])
  @@index([tenantId])
}

model ProjectResource {
  id              String   @id @default(uuid())
  tenantId        String
  projectId       String
  
  resourceType    String   // HUMAN, EQUIPMENT, MATERIAL
  resourceName    String
  employeeId      String?  // For human resources
  
  // Allocation
  allocationPercent Float  @default(100) // Percentage of time allocated
  startDate       DateTime?
  endDate         DateTime?
  
  // Cost
  costPerUnit     Float    @default(0)
  units           Float    @default(1)
  totalCost       Float    @default(0)
  
  // Capacity Tracking
  plannedHours    Float    @default(0)
  actualHours     Float    @default(0)
  availableHours  Float    @default(0)
  
  // For equipment/material
  quantity        Float    @default(1)
  quantityUsed    Float    @default(0)
  quantityUnit    String   @default("unit") // unit, hours, kg, etc.
  
  status          String   @default("ALLOCATED") // ALLOCATED, ACTIVE, RELEASED
  
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([resourceType])
  @@index([employeeId])
}

model ProjectBudget {
  id              String   @id @default(uuid())
  tenantId        String
  projectId       String
  
  category        String   // LABOR, MATERIALS, EQUIPMENT, OVERHEAD, OTHER
  description     String?
  
  // Budget
  plannedAmount   Float    @default(0)
  actualAmount    Float    @default(0)
  variance        Float    @default(0) // Difference between planned and actual
  
  // Dates
  budgetPeriod    String?  // Q1-2026, Monthly-Jan-2026
  transactionDate DateTime @default(now())
  
  notes           String?
  attachments     Json?    // Receipts, invoices
  
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ProjectTimeLog {
  id              String   @id @default(uuid())
  tenantId        String
  projectId       String
  employeeId      String   // Who logged the time
  timesheetId     String?  // Link to timesheet
  
  // Time Details
  logDate         DateTime @default(now())
  hoursWorked     Float    @default(0)
  
  // Task Details
  taskDescription String
  milestoneId     String?  // Optional link to milestone
  
  // Billing
  billable        Boolean  @default(true)
  hourlyRate      Float?
  totalCost       Float?
  
  status          String   @default("LOGGED") // LOGGED, APPROVED, REJECTED, BILLED
  
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  timesheet       ProjectTimesheet? @relation(fields: [timesheetId], references: [id])
  
  @@index([employeeId])
  @@index([projectId])
  @@index([timesheetId])
  @@index([status])
}

model ProjectTimesheet {
  id              String   @id @default(uuid())
  tenantId        String
  employeeId      String
  
  weekStartDate   DateTime // Monday of the week
  weekEndDate     DateTime // Sunday of the week
  
  status          String   @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED
  
  totalHours      Float    @default(0)
  billableHours   Float    @default(0)
  
  submittedAt     DateTime?
  submittedBy     String?
  
  approvedAt      DateTime?
  approvedBy      String?
  rejectedAt      DateTime?
  rejectedBy      String?
  
  rejectionReason String?
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  timeLogs        ProjectTimeLog[]
  
  @@unique([tenantId, employeeId, weekStartDate])
  @@index([employeeId])
  @@index([status])
  @@index([weekStartDate])
}

// ==========================================
// PAYROLL MODULE
// ==========================================

model Attendance {
  id          String   @id @default(uuid())
  tenantId    String
  employeeId  String
  
  date        DateTime
  checkIn     DateTime?
  checkOut    DateTime?
  
  status      String   @default("PRESENT") // PRESENT | ABSENT | LEAVE | HALF_DAY | WORK_FROM_HOME
  workHours   Float    @default(0)
  overtimeHours Float  @default(0)
  
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  employee    Employee @relation(fields: [employeeId], references: [id])
  
  @@unique([tenantId, employeeId, date])
}

model PayrollCycle {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String   // "January 2026 Payroll"
  startDate   DateTime
  endDate     DateTime
  paymentDate DateTime
  
  status      String   @default("DRAFT") // DRAFT | PROCESSING | COMPLETED | PAID
  
  totalGross  Float    @default(0)
  totalDeductions Float @default(0)
  totalNet    Float    @default(0)
  
  processedBy String?
  processedAt DateTime?
  
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  payslips    Payslip[]
  disbursements SalaryDisbursement[]
}

model Payslip {
  id              String   @id @default(uuid())
  tenantId        String
  employeeId      String
  payrollCycleId  String
  
  payslipNumber   String   @unique
  
  // Salary Breakdown
  basicSalary     Float    @default(0)
  allowances      Json?    // {"hra": 5000, "transport": 2000}
  bonuses         Float    @default(0)
  overtime        Float    @default(0)
  
  grossSalary     Float    @default(0)
  
  // Deductions
  taxDeductions   Float    @default(0)
  providentFund   Float    @default(0)
  insurance       Float    @default(0)
  otherDeductions Json?    // {"loan": 1000, "advance": 500}
  
  totalDeductions Float    @default(0)
  netSalary       Float    @default(0)
  
  // Attendance Info
  workingDays     Int      @default(0)
  presentDays     Int      @default(0)
  absentDays      Int      @default(0)
  leaveDays       Int      @default(0)
  
  // Status
  status          String   @default("GENERATED") // GENERATED | APPROVED | PAID
  
  generatedAt     DateTime @default(now())
  approvedBy      String?
  approvedAt      DateTime?
  
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  employee        Employee @relation(fields: [employeeId], references: [id])
  payrollCycle    PayrollCycle @relation(fields: [payrollCycleId], references: [id])
}

model TaxConfiguration {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String   // "Income Tax 2026"
  taxType     String   // INCOME_TAX | PROFESSIONAL_TAX | TDS
  
  // Tax Slabs (JSON array)
  slabs       Json     // [{"min": 0, "max": 250000, "rate": 0}, {"min": 250001, "max": 500000, "rate": 5}]
  
  deductionRules Json? // Rules for deductions
  
  isActive    Boolean  @default(true)
  effectiveFrom DateTime
  effectiveTo   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([tenantId, taxType, effectiveFrom])
}

model SalaryDisbursement {
  id              String   @id @default(uuid())
  tenantId        String
  payrollCycleId  String
  employeeId      String
  
  amount          Float
  paymentMethod   String   // BANK_TRANSFER | CHEQUE | CASH | UPI
  
  // Bank Details
  bankAccount     String?
  transactionRef  String?
  
  status          String   @default("PENDING") // PENDING | PROCESSING | COMPLETED | FAILED
  
  paymentDate     DateTime?
  completedAt     DateTime?
  
  failureReason   String?
  
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  payrollCycle    PayrollCycle @relation(fields: [payrollCycleId], references: [id])
  employee        Employee @relation(fields: [employeeId], references: [id])
}

model SalaryComponent {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String   // "HRA", "Transport Allowance", "PF"
  code        String   // "HRA", "TRANSPORT", "PF"
  type        String   // ALLOWANCE | DEDUCTION | BONUS
  
  calculationType String // FIXED | PERCENTAGE_OF_BASIC | CUSTOM
  value       Float?   // Fixed amount or percentage
  
  formula     String?  // Custom formula if needed
  
  isTaxable   Boolean  @default(true)
  isActive    Boolean  @default(true)
  
  description String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([tenantId, code])
}

// ==========================================
// ATTENDANCE & TIME TRACKING MODULE
// ==========================================

model Shift {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String   // "Morning Shift", "Evening Shift"
  code        String   // "MS", "ES"
  
  startTime   String   // "09:00" - HH:MM format
  endTime     String   // "17:00" - HH:MM format
  breakDuration Int    @default(60) // in minutes
  
  workingDays String   // "1,2,3,4,5" (1=Monday, 7=Sunday) - JSON might be better
  
  isActive    Boolean  @default(true)
  description String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  shiftAssignments ShiftAssignment[]
  overtimePolicies OvertimePolicy[]
  
  @@unique([tenantId, code])
}

model ShiftAssignment {
  id              String   @id @default(uuid())
  tenantId        String
  employeeId      String
  shiftId         String
  
  assignedFrom    DateTime
  assignedTo      DateTime?
  
  status          String   @default("ACTIVE") // ACTIVE | INACTIVE | ENDED
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  employee        Employee @relation(fields: [employeeId], references: [id])
  shift           Shift @relation(fields: [shiftId], references: [id])
  
  @@unique([tenantId, employeeId, shiftId, assignedFrom])
}

model TimeTracking {
  id              String   @id @default(uuid())
  tenantId        String
  employeeId      String
  
  date            DateTime // Just the date part
  checkInTime     DateTime
  checkOutTime    DateTime?
  
  checkInLocation String?  // IP address or GPS coordinates
  checkOutLocation String?
  
  workHours       Float    @default(0) // Calculated
  breakHours      Float    @default(0) // Calculated
  
  status          String   @default("CHECKED_IN") // CHECKED_IN | CHECKED_OUT | INCOMPLETE
  isLate          Boolean  @default(false) // Whether employee clocked in late
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  employee        Employee @relation(fields: [employeeId], references: [id])
  
  @@unique([tenantId, employeeId, date, checkInTime])
}

model OvertimePolicy {
  id              String   @id @default(uuid())
  tenantId        String
  shiftId         String?
  
  name            String   // "Standard OT", "Holiday OT"
  code            String
  
  dailyThreshold  Float    // Hours after which OT starts (e.g., 8 hours)
  weeklyThreshold Float    // Total hours in week
  monthlyThreshold Float?
  
  overtimeRate    Float    // Multiplier (e.g., 1.5x for time-and-a-half)
  weekendRate     Float    @default(2) // 2x for weekends
  holidayRate     Float    @default(2.5) // 2.5x for holidays
  
  isActive        Boolean  @default(true)
  description     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  shift           Shift?   @relation(fields: [shiftId], references: [id])
  overtimeRecords OvertimeRecord[]
  
  @@unique([tenantId, code])
}

model OvertimeRecord {
  id              String   @id @default(uuid())
  tenantId        String
  employeeId      String
  overtimePolicyId String
  
  date            DateTime
  overtimeHours   Float
  overtimeRate    Float
  overtimeAmount  Float
  
  reason          String?
  approvalStatus  String   @default("PENDING") // PENDING | APPROVED | REJECTED
  approvedBy      String?
  approvedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  employee        Employee @relation("EmployeeOvertime", fields: [employeeId], references: [id])
  overtimePolicy  OvertimePolicy @relation(fields: [overtimePolicyId], references: [id])
}

model AttendanceReport {
  id              String   @id @default(uuid())
  tenantId        String
  employeeId      String
  
  reportDate      DateTime // Date of the report
  month           Int      // 1-12
  year            Int      // YYYY
  
  totalWorkingDays Int     @default(0)
  presentDays     Int      @default(0)
  absentDays      Int      @default(0)
  leaveDays       Int      @default(0)
  halfDays        Int      @default(0)
  workFromHomeDays Int     @default(0)
  
  totalWorkHours  Float    @default(0)
  totalOvertimeHours Float @default(0)
  
  attendancePercentage Float @default(0)
  
  status          String   @default("GENERATED") // GENERATED | APPROVED
  
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  employee        Employee @relation("EmployeeAttendanceReport", fields: [employeeId], references: [id])
  
  @@unique([tenantId, employeeId, month, year])
}

model LeaveIntegration {
  id              String   @id @default(uuid())
  tenantId        String
  leaveRequestId  String
  employeeId      String
  
  leaveDate       DateTime
  status          String   @default("PENDING") // PENDING | APPROVED | REJECTED
  
  // When a leave is approved, attendance is marked accordingly
  attendanceStatus String @default("ON_LEAVE") // ON_LEAVE | HALF_DAY_LEAVE | WORK_FROM_HOME
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  employee        Employee @relation("EmployeeLeaveIntegration", fields: [employeeId], references: [id])
  
  @@unique([tenantId, leaveRequestId, leaveDate])
}

// ========================================
// ASSET MANAGEMENT MODULE
// ========================================

model AssetCategory {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String
  code        String
  description String?
  
  // Depreciation defaults for this category
  defaultDepreciationMethod String? // STRAIGHT_LINE | DECLINING_BALANCE | UNITS_OF_PRODUCTION
  defaultDepreciationRate   Float?  // Percentage per year
  defaultUsefulLife         Int?    // In months
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  assets      Asset[]
  
  @@unique([tenantId, code])
}

model Asset {
  id          String   @id @default(uuid())
  tenantId    String
  categoryId  String
  
  // Basic Information
  assetCode   String
  name        String
  description String?
  
  // Purchase Information
  purchaseDate   DateTime
  purchasePrice  Float
  vendor         String?
  invoiceNumber  String?
  
  // Physical Details
  serialNumber   String?
  model          String?
  manufacturer   String?
  location       String?
  
  // Current Status
  status         String   @default("AVAILABLE") // AVAILABLE | ALLOCATED | MAINTENANCE | RETIRED | DISPOSED
  condition      String   @default("GOOD") // EXCELLENT | GOOD | FAIR | POOR
  
  // Depreciation Information
  depreciationMethod String? // STRAIGHT_LINE | DECLINING_BALANCE | UNITS_OF_PRODUCTION
  depreciationRate   Float?  // Percentage per year
  usefulLife         Int?    // In months
  salvageValue       Float?  @default(0)
  
  // Current Values (computed from depreciation)
  currentValue       Float?
  accumulatedDepreciation Float? @default(0)
  
  // Warranty & Insurance
  warrantyExpiry     DateTime?
  insuranceExpiry    DateTime?
  insuranceProvider  String?
  insurancePolicyNo  String?
  
  // Additional Info
  notes              String?
  tags               Json?   // Array of strings for search/filtering
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  category         AssetCategory      @relation(fields: [categoryId], references: [id])
  allocations      AssetAllocation[]
  maintenanceSchedules AssetMaintenance[]
  depreciationRecords  AssetDepreciation[]
  
  @@unique([tenantId, assetCode])
}

model AssetAllocation {
  id              String   @id @default(uuid())
  tenantId        String
  assetId         String
  employeeId      String
  
  // Allocation Details
  allocatedDate   DateTime @default(now())
  returnDate      DateTime?
  expectedReturnDate DateTime?
  
  status          String   @default("ACTIVE") // ACTIVE | RETURNED | OVERDUE
  
  // Allocation Info
  purpose         String?
  allocatedBy     String? // User ID who allocated
  location        String? // Where employee will use the asset
  
  // Return Condition
  returnCondition String? // EXCELLENT | GOOD | FAIR | POOR | DAMAGED
  returnNotes     String?
  
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  asset           Asset    @relation(fields: [assetId], references: [id])
  employee        Employee @relation(fields: [employeeId], references: [id])
}

model AssetMaintenance {
  id              String   @id @default(uuid())
  tenantId        String
  assetId         String
  
  // Schedule Information
  maintenanceType String   // PREVENTIVE | CORRECTIVE | INSPECTION | CALIBRATION
  scheduledDate   DateTime
  completedDate   DateTime?
  
  status          String   @default("SCHEDULED") // SCHEDULED | IN_PROGRESS | COMPLETED | CANCELLED | OVERDUE
  
  // Maintenance Details
  description     String
  performedBy     String?  // Technician or vendor name
  cost            Float?   @default(0)
  
  // Before & After
  conditionBefore String?  // EXCELLENT | GOOD | FAIR | POOR
  conditionAfter  String?  // EXCELLENT | GOOD | FAIR | POOR
  
  // Next Maintenance
  nextMaintenanceDate DateTime?
  
  notes           String?
  attachments     Json?    // Array of file URLs/paths
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  asset           Asset    @relation(fields: [assetId], references: [id])
}

model AssetDepreciation {
  id              String   @id @default(uuid())
  tenantId        String
  assetId         String
  
  // Period Information
  period          DateTime // Usually month-end date
  year            Int
  month           Int      // 1-12
  
  // Depreciation Calculation
  openingValue    Float
  depreciationAmount Float
  closingValue    Float
  accumulatedDepreciation Float
  
  method          String   // STRAIGHT_LINE | DECLINING_BALANCE | UNITS_OF_PRODUCTION
  rate            Float    // Percentage or units
  
  notes           String?
  
  createdAt       DateTime @default(now())
  
  asset           Asset    @relation(fields: [assetId], references: [id])
  
  @@unique([tenantId, assetId, year, month])
}

// ==================== DOCUMENT MANAGEMENT MODULE ====================

model DocumentFolder {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  parentId    String?
  path        String   // Full path for easy navigation: /parent/child/current
  color       String?  // Optional folder color
  icon        String?  // Optional icon
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  parent      DocumentFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id])
  children    DocumentFolder[] @relation("FolderHierarchy")
  documents   Document[]
  permissions DocumentFolderPermission[]
  
  @@unique([tenantId, parentId, name])
  @@index([tenantId, parentId])
}

model Document {
  id              String   @id @default(uuid())
  tenantId        String
  folderId        String?
  name            String
  description     String?
  fileName        String   // Original file name
  fileSize        Int      // In bytes
  mimeType        String
  storagePath     String   // Path in storage system
  storageProvider String   @default("LOCAL") // LOCAL | S3 | AZURE | GCS
  checksum        String?  // For integrity verification
  
  // Metadata
  tags            String[] // Array of tags for searching
  metadata        Json?    // Custom metadata
  
  // Version control
  version         Int      @default(1)
  isLatest        Boolean  @default(true)
  
  // Status
  status          String   @default("ACTIVE") // ACTIVE | ARCHIVED | DELETED
  
  // Access
  isPublic        Boolean  @default(false)
  downloadCount   Int      @default(0)
  viewCount       Int      @default(0)
  
  // Template
  isTemplate      Boolean  @default(false)
  templateId      String?
  
  // Audit
  createdBy       String
  updatedBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  folder          DocumentFolder?         @relation(fields: [folderId], references: [id])
  template        DocumentTemplate?       @relation(fields: [templateId], references: [id])
  versions        DocumentVersion[]
  shares          DocumentShare[]
  permissions     DocumentPermission[]
  activities      DocumentActivity[]
  comments        DocumentComment[]
  
  @@index([tenantId, folderId])
  @@index([tenantId, status])
  @@index([tenantId, isTemplate])
}

model DocumentVersion {
  id              String   @id @default(uuid())
  documentId      String
  versionNumber   Int
  fileName        String
  fileSize        Int
  storagePath     String
  checksum        String?
  changeLog       String?
  
  createdBy       String
  createdAt       DateTime @default(now())
  
  document        Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  @@unique([documentId, versionNumber])
  @@index([documentId])
}

model DocumentTemplate {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  category    String?  // CONTRACT | INVOICE | REPORT | LETTER | etc.
  fileName    String
  storagePath String
  fileSize    Int
  mimeType    String
  
  // Template fields that can be filled
  fields      Json?    // [{name: "customerName", type: "text", required: true}]
  
  // Usage stats
  usageCount  Int      @default(0)
  
  isActive    Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  documents   Document[]
  
  @@index([tenantId, category])
}

model DocumentShare {
  id            String   @id @default(uuid())
  documentId    String
  shareType     String   // LINK | EMAIL | USER
  
  // For link sharing
  shareToken    String?  @unique
  expiresAt     DateTime?
  password      String?  // Optional password protection
  maxDownloads  Int?
  downloadCount Int      @default(0)
  
  // For user sharing
  sharedWith    String?  // User ID or email
  
  // Permissions
  canView       Boolean  @default(true)
  canDownload   Boolean  @default(true)
  canEdit       Boolean  @default(false)
  canShare      Boolean  @default(false)
  
  isActive      Boolean  @default(true)
  createdBy     String
  createdAt     DateTime @default(now())
  
  document      Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  activities    DocumentActivity[]
  
  @@index([documentId])
  @@index([shareToken])
  @@index([sharedWith])
}

model DocumentPermission {
  id          String   @id @default(uuid())
  documentId  String
  userId      String?
  roleId      String?
  
  canView     Boolean  @default(true)
  canEdit     Boolean  @default(false)
  canDelete   Boolean  @default(false)
  canShare    Boolean  @default(false)
  canManage   Boolean  @default(false) // Manage permissions
  
  createdAt   DateTime @default(now())
  
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  @@unique([documentId, userId])
  @@unique([documentId, roleId])
  @@index([documentId])
  @@index([userId])
  @@index([roleId])
}

model DocumentFolderPermission {
  id          String          @id @default(uuid())
  folderId    String
  userId      String?
  roleId      String?
  
  canView     Boolean  @default(true)
  canEdit     Boolean  @default(false)
  canDelete   Boolean  @default(false)
  canCreate   Boolean  @default(false) // Create documents in folder
  canManage   Boolean  @default(false) // Manage permissions
  
  createdAt   DateTime @default(now())
  
  folder      DocumentFolder @relation(fields: [folderId], references: [id], onDelete: Cascade)
  
  @@unique([folderId, userId])
  @@unique([folderId, roleId])
  @@index([folderId])
  @@index([userId])
  @@index([roleId])
}

model DocumentActivity {
  id          String   @id @default(uuid())
  documentId  String?
  shareId     String?
  tenantId    String
  userId      String?
  action      String   // CREATED | UPDATED | VIEWED | DOWNLOADED | SHARED | DELETED | RESTORED | VERSION_CREATED
  details     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  
  document    Document?      @relation(fields: [documentId], references: [id], onDelete: Cascade)
  share       DocumentShare? @relation(fields: [shareId], references: [id], onDelete: Cascade)
  
  @@index([documentId])
  @@index([shareId])
  @@index([tenantId, userId])
  @@index([createdAt])
}

model DocumentComment {
  id          String   @id @default(uuid())
  documentId  String
  userId      String
  content     String
  parentId    String?  // For threaded comments
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  document    Document          @relation(fields: [documentId], references: [id], onDelete: Cascade)
  parent      DocumentComment?  @relation("CommentThread", fields: [parentId], references: [id])
  replies     DocumentComment[] @relation("CommentThread")
  
  @@index([documentId])
  @@index([userId])
}

// ==================== REPORTS & ANALYTICS MODULE ====================

model ReportTemplate {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String   // "P&L Report", "HR Analytics", "Inventory Report"
  type        String   // FINANCIAL | HR | INVENTORY | CUSTOM
  category    String?  // PROFIT_LOSS | BALANCE_SHEET | EMPLOYEE_ANALYTICS | STOCK_REPORT
  
  description String?
  isSystem    Boolean  @default(false) // System templates cannot be deleted
  isActive    Boolean  @default(true)
  
  // Report Configuration
  config      Json     // Stores report structure, filters, columns, calculations
  
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  reports     Report[]
  
  @@index([tenantId, type])
}

model Report {
  id            String   @id @default(uuid())
  tenantId      String
  templateId    String?
  
  name          String
  type          String   // FINANCIAL | HR | INVENTORY | CUSTOM
  
  // Report Parameters
  parameters    Json?    // Date ranges, filters, etc.
  
  // Report Data (cached for quick access)
  data          Json?
  
  // Metadata
  generatedBy   String?
  generatedAt   DateTime @default(now())
  
  createdAt     DateTime @default(now())
  
  template      ReportTemplate? @relation(fields: [templateId], references: [id])
  
  @@index([tenantId, type])
  @@index([generatedAt])
}

model ReportSchedule {
  id          String   @id @default(uuid())
  tenantId    String
  templateId  String
  
  name        String
  frequency   String   // DAILY | WEEKLY | MONTHLY | QUARTERLY | YEARLY
  recipients  Json     // Array of email addresses
  
  isActive    Boolean  @default(true)
  lastRunAt   DateTime?
  nextRunAt   DateTime?
  
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([nextRunAt])
}

// ==================== COMMUNICATION MODULE ====================

model Conversation {
  id          String   @id @default(uuid())
  tenantId    String
  
  type        String   // DIRECT | GROUP | CHANNEL
  name        String?  // For group chats and channels
  description String?
  
  // Metadata
  createdBy   String
  isArchived  Boolean  @default(false)
  lastMessageAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  messages    Message[]
  participants ConversationParticipant[]
  
  @@index([tenantId, type])
  @@index([tenantId, lastMessageAt])
}

model ConversationParticipant {
  id              String   @id @default(uuid())
  conversationId  String
  userId          String
  
  // Participant settings
  role            String   @default("MEMBER") // ADMIN | MEMBER
  isMuted         Boolean  @default(false)
  lastReadAt      DateTime?
  
  joinedAt        DateTime @default(now())
  
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
}

model Message {
  id              String   @id @default(uuid())
  conversationId  String
  senderId        String
  
  content         String   @db.Text
  type            String   @default("TEXT") // TEXT | FILE | IMAGE | SYSTEM
  
  // File attachments
  attachments     Json?    // Array of file metadata
  
  // Message metadata
  isEdited        Boolean  @default(false)
  isDeleted       Boolean  @default(false)
  
  // Mentions and replies
  mentionedUserIds Json?   // Array of user IDs
  replyToId       String?  // ID of message being replied to
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  reactions       MessageReaction[]
  readReceipts    MessageReadReceipt[]
  
  @@index([conversationId, createdAt])
  @@index([senderId])
}

model MessageReaction {
  id         String   @id @default(uuid())
  messageId  String
  userId     String
  emoji      String   // Ã°Å¸â€˜Â Ã¢ÂÂ¤Ã¯Â¸Â Ã°Å¸Ëœâ€š etc.
  
  createdAt  DateTime @default(now())
  
  message    Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

model MessageReadReceipt {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())
  
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

model Announcement {
  id          String   @id @default(uuid())
  tenantId    String
  
  title       String
  content     String   @db.Text
  priority    String   @default("NORMAL") // LOW | NORMAL | HIGH | URGENT
  
  // Targeting
  targetType  String   @default("ALL") // ALL | DEPARTMENT | ROLE | SPECIFIC_USERS
  targetIds   Json?    // Array of department IDs, role IDs, or user IDs
  
  // Attachments
  attachments Json?
  
  // Publishing
  publishedBy String
  publishedAt DateTime @default(now())
  expiresAt   DateTime?
  
  isPinned    Boolean  @default(false)
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  reads       AnnouncementRead[]
  
  @@index([tenantId, isActive, publishedAt])
  @@index([tenantId, isPinned])
}

model AnnouncementRead {
  id             String   @id @default(uuid())
  announcementId String
  userId         String
  readAt         DateTime @default(now())
  
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  
  @@unique([announcementId, userId])
  @@index([userId])
}

model EmailTemplate {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String   // "Welcome Email", "Invoice", "Leave Approval"
  code        String   // Unique identifier for programmatic access
  subject     String
  body        String   @db.Text // HTML content
  
  variables   Json?    // Available variables for template
  
  isSystem    Boolean  @default(false)
  isActive    Boolean  @default(true)
  
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([tenantId, code])
  @@index([tenantId, isActive])
}

model EmailLog {
  id          String   @id @default(uuid())
  tenantId    String
  
  to          String
  cc          String?
  bcc         String?
  subject     String
  body        String   @db.Text
  
  templateId  String?
  
  status      String   @default("PENDING") // PENDING | SENT | FAILED | BOUNCED
  sentAt      DateTime?
  failedAt    DateTime?
  errorMessage String?  @db.Text
  
  metadata    Json?    // Additional tracking info
  
  createdAt   DateTime @default(now())
  
  @@index([tenantId, status])
  @@index([to])
  @@index([createdAt])
}

model ChatChannel {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String
  description String?
  type        String   @default("PUBLIC") // PUBLIC | PRIVATE
  
  // Department or project specific
  departmentId String?
  projectId   String?
  
  createdBy   String
  isArchived  Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  members     ChatChannelMember[]
  
  @@index([tenantId, type, isArchived])
  @@index([departmentId])
  @@index([projectId])
}

model ChatChannelMember {
  id        String   @id @default(uuid())
  channelId String
  userId    String
  
  role      String   @default("MEMBER") // ADMIN | MODERATOR | MEMBER
  isMuted   Boolean  @default(false)
  
  joinedAt  DateTime @default(now())
  
  channel   ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  
  @@unique([channelId, userId])
  @@index([userId])
}

// ==========================================
// BRANCH/LOCATION MANAGEMENT
// ==========================================

model Branch {
  id          String   @id @default(uuid())
  tenantId    String
  
  code        String   // Branch code (e.g., "BR001", "NYC-01")
  name        String
  type        String   @default("BRANCH") // BRANCH | WAREHOUSE | STORE | OFFICE
  
  // Address
  address     String?
  city        String?
  state       String?
  country     String?
  postalCode  String?
  
  // Contact
  phone       String?
  email       String?
  
  // Manager
  managerId   String?
  
  // Settings
  isActive    Boolean  @default(true)
  isMainBranch Boolean @default(false)
  
  // Operating hours
  operatingHours Json? // {"monday": {"open": "09:00", "close": "17:00"}}
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  warehouses  Warehouse[]
  
  @@unique([tenantId, code])
  @@index([tenantId, isActive])
}

// ==========================================
// ENHANCED INVENTORY MANAGEMENT
// ==========================================

model Warehouse {
  id          String   @id @default(uuid())
  tenantId    String
  branchId    String?
  
  code        String   // Warehouse code (e.g., "WH001", "MAIN-WH")
  name        String
  type        String   @default("GENERAL") // GENERAL | COLD_STORAGE | HAZARDOUS | BONDED
  
  // Address
  address     String?
  city        String?
  state       String?
  country     String?
  postalCode  String?
  
  // Capacity
  capacity    Float?   // Total capacity in cubic meters or sqft
  unit        String?  // CUBIC_METER | SQFT | PALLET
  
  // Contact
  managerId   String?
  phone       String?
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  branch      Branch?  @relation(fields: [branchId], references: [id])
  stockItems  WarehouseStock[]
  stockMovements StockMovement[]
  
  @@unique([tenantId, code])
  @@index([tenantId, isActive])
}

model WarehouseStock {
  id          String   @id @default(uuid())
  tenantId    String
  warehouseId String
  itemId      String   // Reference to Item model
  
  quantity    Float    @default(0)
  reservedQty Float    @default(0) // Reserved for orders
  availableQty Float   @default(0) // quantity - reservedQty
  
  // Location within warehouse
  binLocation String?  // e.g., "A-12-03" (Aisle-Rack-Shelf)
  zone        String?  // e.g., "COLD", "DRY", "HAZMAT"
  
  // Reorder settings
  reorderPoint Float?
  reorderQty   Float?
  minStock     Float?
  maxStock     Float?
  
  // Cost tracking
  lastPurchasePrice Float?
  avgCost      Float?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  
  @@unique([warehouseId, itemId])
  @@index([tenantId, itemId])
  @@index([warehouseId])
}

model StockMovement {
  id              String   @id @default(uuid())
  tenantId        String
  
  movementNumber  String   // Auto-generated (e.g., "SM-2026-0001")
  type            String   // IN | OUT | TRANSFER | ADJUSTMENT | RETURN
  reason          String?  // PURCHASE | SALE | DAMAGED | EXPIRED | CORRECTION | TRANSFER
  
  itemId          String
  
  // Warehouse details
  fromWarehouseId String?
  toWarehouseId   String?
  warehouseId     String?  // For IN/OUT/ADJUSTMENT
  
  quantity        Float
  
  // Lot/Batch tracking
  lotNumber       String?
  batchNumber     String?
  serialNumber    String?
  expiryDate      DateTime?
  
  // Reference documents
  referenceType   String?  // PURCHASE_ORDER | SALES_ORDER | WORK_ORDER | ADJUSTMENT
  referenceId     String?
  
  // Cost
  unitCost        Float?
  totalCost       Float?
  
  // Status & Approval
  status          String   @default("PENDING") // PENDING | APPROVED | COMPLETED | CANCELLED
  approvedBy      String?
  approvedAt      DateTime?
  
  notes           String?  @db.Text
  createdBy       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  warehouse       Warehouse? @relation(fields: [warehouseId], references: [id])
  
  @@unique([tenantId, movementNumber])
  @@index([tenantId, type, status])
  @@index([itemId])
  @@index([referenceType, referenceId])
}

model LotBatch {
  id              String   @id @default(uuid())
  tenantId        String
  itemId          String
  
  lotNumber       String?
  batchNumber     String?
  serialNumber    String?
  
  manufacturingDate DateTime?
  expiryDate      DateTime?
  
  quantity        Float
  remainingQty    Float
  
  supplier        String?
  purchaseOrderId String?
  
  status          String   @default("ACTIVE") // ACTIVE | EXPIRED | RECALLED | DEPLETED
  
  notes           String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([tenantId, lotNumber])
  @@index([tenantId, itemId])
  @@index([expiryDate])
}

// ==========================================
// FINANCIAL ACCOUNTING
// ==========================================

model ChartOfAccounts {
  id          String   @id @default(uuid())
  tenantId    String
  
  accountCode String   // e.g., "1000", "2000", "3000"
  accountName String
  accountType String   // ASSET | LIABILITY | EQUITY | REVENUE | EXPENSE
  category    String?  // CURRENT_ASSET | FIXED_ASSET | CURRENT_LIABILITY | etc.
  
  parentId    String?  // For hierarchical structure
  
  description String?  @db.Text
  
  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false) // System-defined accounts
  
  // Balance tracking
  normalBalance String  // DEBIT | CREDIT
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  parent      ChartOfAccounts? @relation("AccountHierarchy", fields: [parentId], references: [id])
  children    ChartOfAccounts[] @relation("AccountHierarchy")
  
  journalEntries JournalEntryLine[]
  ledgerEntries  LedgerEntry[]
  
  @@unique([tenantId, accountCode])
  @@index([tenantId, accountType])
}

model JournalEntry {
  id              String   @id @default(uuid())
  tenantId        String
  
  entryNumber     String   // Auto-generated (e.g., "JE-2026-0001")
  entryDate       DateTime @default(now())
  postingDate     DateTime?
  
  type            String   @default("STANDARD") // STANDARD | OPENING | CLOSING | ADJUSTING
  
  description     String   @db.Text
  referenceType   String?  // INVOICE | PAYMENT | EXPENSE | PAYROLL
  referenceId     String?
  
  status          String   @default("DRAFT") // DRAFT | POSTED | APPROVED | REVERSED
  
  totalDebit      Float    @default(0)
  totalCredit     Float    @default(0)
  
  createdBy       String
  approvedBy      String?
  approvedAt      DateTime?
  postedBy        String?
  postedAt        DateTime?
  
  reversedBy      String?
  reversedAt      DateTime?
  reversingEntryId String? // Reference to reversing entry
  
  attachments     Json?    // File references
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  lines           JournalEntryLine[]
  
  @@unique([tenantId, entryNumber])
  @@index([tenantId, status])
  @@index([entryDate])
}

model JournalEntryLine {
  id              String   @id @default(uuid())
  journalEntryId  String
  accountId       String
  
  lineNumber      Int
  description     String?  @db.Text
  
  debit           Float    @default(0)
  credit          Float    @default(0)
  
  // Dimension tracking
  departmentId    String?
  projectId       String?
  costCenter      String?
  
  createdAt       DateTime @default(now())
  
  journalEntry    JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account         ChartOfAccounts @relation(fields: [accountId], references: [id])
  
  @@index([journalEntryId])
  @@index([accountId])
}

model LedgerEntry {
  id              String   @id @default(uuid())
  tenantId        String
  accountId       String
  
  date            DateTime
  description     String   @db.Text
  
  debit           Float    @default(0)
  credit          Float    @default(0)
  balance         Float    @default(0)
  
  referenceType   String?  // JOURNAL_ENTRY | INVOICE | PAYMENT
  referenceId     String?
  
  journalEntryId  String?
  
  createdAt       DateTime @default(now())
  
  account         ChartOfAccounts @relation(fields: [accountId], references: [id])
  
  @@index([tenantId, accountId, date])
  @@index([date])
}

model FiscalYear {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String   // e.g., "FY 2026"
  startDate   DateTime
  endDate     DateTime
  
  isClosed    Boolean  @default(false)
  closedBy    String?
  closedAt    DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([tenantId, name])
  @@index([tenantId, startDate, endDate])
}

// ==========================================
// MANUFACTURING & PRODUCTION
// ==========================================

model BillOfMaterials {
  id          String   @id @default(uuid())
  tenantId    String
  
  bomNumber   String   // e.g., "BOM-0001"
  productId   String   // Item that is produced
  
  version     String   @default("1.0")
  name        String
  description String?  @db.Text
  
  quantity    Float    @default(1) // Base quantity this BOM produces
  unit        String?
  
  // Costing
  materialCost Float?
  laborCost   Float?
  overheadCost Float?
  totalCost   Float?
  
  status      String   @default("DRAFT") // DRAFT | ACTIVE | ARCHIVED
  
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false) // Default BOM for this product
  
  effectiveFrom DateTime?
  effectiveTo   DateTime?
  
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  items       BOMItem[]
  workOrders  WorkOrder[]
  
  @@unique([tenantId, bomNumber])
  @@index([tenantId, productId])
}

model BOMItem {
  id          String   @id @default(uuid())
  bomId       String
  itemId      String   // Raw material or component
  
  sequence    Int      // Order of assembly
  quantity    Float    // Quantity required per base quantity
  unit        String?
  
  // Sourcing
  warehouseId String?
  
  // Costing
  unitCost    Float?
  totalCost   Float?
  
  // Alternatives
  alternativeItems Json? // List of alternative item IDs
  
  scrapPercentage Float? @default(0)
  
  notes       String?  @db.Text
  
  createdAt   DateTime @default(now())
  
  bom         BillOfMaterials @relation(fields: [bomId], references: [id], onDelete: Cascade)
  
  @@index([bomId])
  @@index([itemId])
}

model WorkOrder {
  id              String   @id @default(uuid())
  tenantId        String
  
  workOrderNumber String   // e.g., "WO-2026-0001"
  bomId           String
  productId       String   // What is being produced
  
  // Quantity
  plannedQty      Float
  producedQty     Float    @default(0)
  scrappedQty     Float    @default(0)
  
  // Scheduling
  scheduledStart  DateTime?
  scheduledEnd    DateTime?
  actualStart     DateTime?
  actualEnd       DateTime?
  
  // Location
  warehouseId     String?  // Where to deliver finished goods
  workCenter      String?  // Production line/area
  
  // Status
  status          String   @default("DRAFT") // DRAFT | PLANNED | IN_PROGRESS | COMPLETED | CANCELLED
  priority        String   @default("NORMAL") // LOW | NORMAL | HIGH | URGENT
  
  // Costing
  estimatedCost   Float?
  actualCost      Float?
  
  // References
  salesOrderId    String?
  projectId       String?
  
  // Assignment
  assignedTo      String?  // Supervisor/Manager
  
  notes           String?  @db.Text
  
  createdBy       String
  completedBy     String?
  completedAt     DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  bom             BillOfMaterials @relation(fields: [bomId], references: [id])
  operations      WorkOrderOperation[]
  materialUsage   WorkOrderMaterial[]
  
  @@unique([tenantId, workOrderNumber])
  @@index([tenantId, status])
  @@index([productId])
}

model WorkOrderOperation {
  id              String   @id @default(uuid())
  workOrderId     String
  
  sequence        Int
  operationName   String
  description     String?  @db.Text
  
  workCenter      String?
  
  // Time tracking
  estimatedHours  Float?
  actualHours     Float?
  
  // Labor
  assignedTo      String?
  laborCost       Float?
  
  status          String   @default("PENDING") // PENDING | IN_PROGRESS | COMPLETED | SKIPPED
  
  startedAt       DateTime?
  completedAt     DateTime?
  
  notes           String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  workOrder       WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  
  @@index([workOrderId])
}

model WorkOrderMaterial {
  id              String   @id @default(uuid())
  workOrderId     String
  itemId          String
  
  plannedQty      Float
  issuedQty       Float    @default(0)
  consumedQty     Float    @default(0)
  returnedQty     Float    @default(0)
  
  warehouseId     String?
  
  unitCost        Float?
  totalCost       Float?
  
  status          String   @default("PENDING") // PENDING | ISSUED | CONSUMED | RETURNED
  
  issuedBy        String?
  issuedAt        DateTime?
  
  notes           String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  workOrder       WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  
  @@index([workOrderId])
  @@index([itemId])
}

model ProductionBatch {
  id              String   @id @default(uuid())
  tenantId        String
  workOrderId     String
  
  batchNumber     String
  productId       String
  
  quantity        Float
  unit            String?
  
  manufacturingDate DateTime @default(now())
  expiryDate      DateTime?
  
  qualityStatus   String   @default("PENDING") // PENDING | PASSED | FAILED | QUARANTINE
  qcBy            String?
  qcAt            DateTime?
  qcNotes         String?  @db.Text
  
  warehouseId     String?
  
  status          String   @default("IN_PRODUCTION") // IN_PRODUCTION | COMPLETED | SCRAPPED
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([tenantId, batchNumber])
  @@index([tenantId, workOrderId])
  @@index([productId])
}
