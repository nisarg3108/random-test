generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model CompanyConfig {
  id       String @id @default(uuid())
  tenantId String @unique
  
  // Company Details
  companyName String
  industry    String
  size        String // SMALL | MEDIUM | LARGE
  country     String?
  currency    String?
  timezone    String?
  fiscalYear  String?
  
  // Workflow Configuration
  workflowConfig Json? // Custom workflow rules per module
  
  // Module Settings
  enabledModules Json? // ["INVENTORY", "HR", "FINANCE"]
  
  // Approval Settings
  approvalLevels Json? // {"inventory": 2, "expense": 3, "leave": 1}
  
  // Custom Fields
  customFields Json? // Module-specific custom fields
  
  // Business Rules
  businessRules Json? // Custom validation rules
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model User {
  id       String @id @default(uuid())
  email    String @unique
  password String
  role     String @default("USER")
  status   String @default("ACTIVE")

  tenantId     String
  departmentId String?
  managerId    String?

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  department Department? @relation(fields: [departmentId], references: [id])
  roles      UserRole[]
  employee   Employee?

  createdAt DateTime @default(now())
}

model Role {
  id       String @id @default(uuid())
  name     String
  tenantId String

  permissions RolePermission[]
  users       UserRole[]

  @@unique([name, tenantId])
}

model Permission {
  id    String @id @default(uuid())
  code  String @unique
  label String

  roles RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

model Department {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  createdAt DateTime @default(now())

  employees Employee[]
  User      User[]
}

model Workflow {
  id       String @id @default(uuid())
  tenantId String
  module   String // INVENTORY, HR, FINANCE
  action   String // CREATE, UPDATE, DELETE
  status   String @default("ACTIVE") // ACTIVE, REJECTED

  steps     WorkflowStep[]
  approvals Approval[]
  createdAt DateTime     @default(now())
}

model WorkflowStep {
  id         String @id @default(uuid())
  workflowId String
  stepOrder  Int
  permission String // inventory.approve, finance.approve

  workflow  Workflow   @relation(fields: [workflowId], references: [id])
  approvals Approval[]
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  tenantId  String
  action    String
  entity    String
  entityId  String
  meta      Json?
  timestamp DateTime @default(now())
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  users   User[]
  config  CompanyConfig?
  items   Item[]
  invites UserInvite[]
}

model Item {
  id          String   @id @default(uuid())
  name        String
  sku         String
  price       Float
  quantity    Int      @default(0)
  description String?
  category    String?
  tenantId    String
  createdAt   DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([sku, tenantId])
}

model UserInvite {
  id        String   @id @default(uuid())
  email     String
  role      String   @default("USER")
  token     String   @unique
  used      Boolean  @default(false)
  expiresAt DateTime
  tenantId  String
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model Approval {
  id              String    @id @default(uuid())
  workflowId      String
  workflowStepId  String?
  stepOrder       Int
  permission      String
  data            Json?
  tenantId        String
  approvedBy      String?
  approvedAt      DateTime?
  status          String    // PENDING | APPROVED | REJECTED
  comment         String?
  rejectionReason String?
  createdAt       DateTime  @default(now())

  workflow     Workflow      @relation(fields: [workflowId], references: [id])
  workflowStep WorkflowStep? @relation(fields: [workflowStepId], references: [id])
}

model SystemOption {
  id        String   @id @default(uuid())
  category  String
  key       String
  value     String
  label     String?
  tenantId  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([category, key, tenantId], name: "category_key_tenantId")
}

model WorkflowRequest {
  id         String   @id @default(uuid())
  tenantId   String
  workflowId String?
  module     String
  action     String
  payload    Json // original request body
  status     String // PENDING | COMPLETED | REJECTED
  createdBy  String // Keep old field
  requestedBy String? // Add new optional field
  createdAt  DateTime @default(now())
}

model Employee {
  id           String  @id @default(uuid())
  tenantId     String
  userId       String  @unique
  departmentId String
  managerId    String?

  employeeCode String
  name         String
  email        String
  designation  String
  joiningDate  DateTime
  status       String

  createdAt DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id])
  department Department @relation(fields: [departmentId], references: [id])
  manager    Employee?  @relation("EmployeeManager", fields: [managerId], references: [id])
  reports    Employee[] @relation("EmployeeManager")

  expenseClaims   ExpenseClaim[]
  LeaveRequest    LeaveRequest[]
  tasks           Task[]
  assignedTasks   Task[] @relation("TaskAssigner")
  salaryStructure SalaryStructure?
  workReports     WorkReport[]
  notifications   Notification[]
}

model LeaveType {
  id       String @id @default(uuid())
  tenantId String

  name            String
  code            String
  maxDays         Int
  paid            Boolean
  requiresApproval Boolean @default(true)

  createdAt DateTime @default(now())

  // âœ… ADD THIS
  leaveRequests LeaveRequest[]
}

model LeaveRequest {
  id          String @id @default(uuid())
  tenantId    String
  employeeId  String
  leaveTypeId String

  startDate DateTime
  endDate   DateTime
  reason    String

  status String // PENDING | APPROVED | REJECTED

  createdAt DateTime @default(now())

  employee  Employee  @relation(fields: [employeeId], references: [id])
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])
}

model ExpenseCategory {
  id       String @id @default(uuid())
  tenantId String

  name   String
  code   String // TRAVEL, FOOD, OFFICE
  active Boolean @default(true)

  createdAt     DateTime       @default(now())
  expenseClaims ExpenseClaim[]
}

model ExpenseClaim {
  id         String @id @default(uuid())
  tenantId   String
  employeeId String
  categoryId String

  title       String
  amount      Float
  description String?
  receiptUrl  String?
  expenseDate DateTime

  status String // PENDING | APPROVED | REJECTED

  createdAt DateTime @default(now())

  employee Employee        @relation(fields: [employeeId], references: [id])
  category ExpenseCategory @relation(fields: [categoryId], references: [id])
}

model Task {
  id          String @id @default(uuid())
  tenantId    String
  employeeId  String
  assignedBy  String
  
  title       String
  description String
  priority    String // LOW | MEDIUM | HIGH | URGENT
  status      String @default("PENDING") // PENDING | IN_PROGRESS | COMPLETED
  dueDate     DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  employee    Employee @relation(fields: [employeeId], references: [id])
  assigner    Employee @relation("TaskAssigner", fields: [assignedBy], references: [id])
  reports     WorkReport[]
}

model SalaryStructure {
  id          String @id @default(uuid())
  tenantId    String
  employeeId  String @unique
  
  basicSalary Float
  allowances  Json // {"hra": 5000, "transport": 2000, "medical": 1500}
  deductions  Json // {"pf": 1800, "tax": 3000, "insurance": 500}
  netSalary   Float
  
  effectiveFrom DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  employee    Employee @relation(fields: [employeeId], references: [id])
}

model WorkReport {
  id          String @id @default(uuid())
  tenantId    String
  employeeId  String
  taskId      String?
  
  title       String
  description String
  workDate    DateTime
  hoursSpent  Float?
  attachments Json? // Array of file URLs/paths
  
  createdAt   DateTime @default(now())
  
  employee    Employee @relation(fields: [employeeId], references: [id])
  task        Task?    @relation(fields: [taskId], references: [id])
}

model Notification {
  id         String @id @default(uuid())
  tenantId   String
  employeeId String
  
  type       String // TASK_ASSIGNED | DEADLINE_REMINDER | TASK_OVERDUE | SALARY_UPDATE
  title      String
  message    String
  isRead     Boolean @default(false)
  
  createdAt  DateTime @default(now())
  
  employee   Employee @relation(fields: [employeeId], references: [id])
}

model PasswordReset {
  id        String   @id @default(uuid())
  email     String
  otp       String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([email, otp])
}

model WorkflowTemplate {
  id          String @id @default(uuid())
  name        String
  description String
  industry    String // MANUFACTURING | IT | RETAIL | HEALTHCARE
  module      String // INVENTORY | HR | FINANCE
  
  steps       Json   // Predefined workflow steps
  isDefault   Boolean @default(false)
  
  createdAt   DateTime @default(now())
}

model CustomField {
  id       String @id @default(uuid())
  tenantId String
  module   String // EMPLOYEE | INVENTORY | EXPENSE
  
  fieldName String
  fieldType String // TEXT | NUMBER | DATE | DROPDOWN | BOOLEAN
  options   Json?  // For dropdown fields
  required  Boolean @default(false)
  
  createdAt DateTime @default(now())
}

model ApprovalMatrix {
  id       String @id @default(uuid())
  tenantId String
  module   String // INVENTORY | EXPENSE | LEAVE
  
  conditions Json // Amount ranges, department rules
  approvers  Json // Role-based approver hierarchy
  
  createdAt DateTime @default(now())
}
